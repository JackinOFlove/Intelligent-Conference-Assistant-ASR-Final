<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
    <title>ä¼šè®®åŠ©æ‰‹</title>
    <style>
        body {
            font-family: 'å¾®è½¯é›…é»‘', sans-serif;
            background-color: #e9f1f5;
            margin: 0;
            padding: 0;
            color: #333;
        }

        h1 {
            text-align: center;
            font-size: 36px;
            margin: 20px 0;
        }

        .chat-container {
            max-width: 800px;
            margin: 0px auto;
            padding: 20px;
            height: 80vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.2);
            border-radius: 12px;
            background-color: #ffffff;
            transition: transform 0.3s;
        }

        .chat-container:hover {
            transform: scale(1.02);
        }

        .chat-box {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            border: 1px solid #d0d0d0;
            border-radius: 10px;
            margin-bottom: 20px;
            background-color: #f9f9f9;
        }

        .message {
            margin: 10px 0;
            padding: 12px;
            border-radius: 10px;
            max-width: 80%;
            white-space: pre-wrap;
            font-size: 15px;
            transition: background-color 0.3s;
            position: relative;
        }

        .user {
            background-color: #cce5ff;
            margin-left: auto;
        }

        .assistant {
            background-color: #f5c6cb;
            margin-right: auto;
        }

        .streaming {
            opacity: 0.8;
        }

        .input-area {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        textarea {
            flex: 1;
            height: 80px;
            padding: 12px;
            border: 1px solid #d0d0d0;
            border-radius: 6px;
            resize: none;
            font-size: 15px;
            transition: border-color 0.3s, box-shadow 0.3s;
        }

        textarea:focus {
            border-color: #007bff;
            box-shadow: 0 0 5px rgba(0, 123, 255, 0.5);
            outline: none;
        }



        button {
            background-color: #007bff;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            display: block;
            margin: 20px auto;
            transition: background-color 0.3s;
        }

        button:hover {
            background-color: #0056b3;
        }

        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        .back-button {
            margin: 20px;
            padding: 10px 15px;
            font-size: 12px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s;
            position: absolute;
            /* absolute positioning */
            top: 20px;
            /* 20px from top */
            left: 20px;
            /* 20px from left */
        }

        .back-button:hover {
            background-color: #0056b3;
            transform: scale(1.05);
        }
    </style>
</head>

<body>
    <h1>
        <svg t="1733578359861" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg"
            p-id="4796" width="50" height="50">
            <path d="M28.668 582.4H114.8v36H28.668z" fill="#6E6E96" p-id="4797"></path>
            <path
                d="M904.944 852.616c0 72.084-58.976 131.068-131.064 131.068H245.864c-72.088 0-131.068-58.98-131.068-131.068V401.92c0-72.088 58.98-131.068 131.068-131.068h528.02c72.084 0 131.064 58.98 131.064 131.068v450.696z"
                fill="#E2E2EA" p-id="4798"></path>
            <path
                d="M830.064 298.644a125.788 125.788 0 0 1 14.58 58.816v436.492c0 69.812-57.124 126.936-126.94 126.936H206.324a125.736 125.736 0 0 1-58.816-14.576c21.3 40.404 63.74 68.12 112.364 68.12h511.38c69.82 0 126.94-57.12 126.94-126.936V411.012c-0.004-48.628-27.724-91.06-68.128-112.368z"
                fill="#6E6E96" opacity=".2" p-id="4799"></path>
            <path
                d="M173.788 877.832V448.936c0-68.6 56.128-124.728 124.728-124.728h502.476c20.156 0 43.184 2.728 43.184 2.728-14.84-46.668-49.896-57.884-98.336-57.884H243.364c-68.6 0-124.728 56.128-124.728 124.728v428.892c0 48.444 14.7 78.928 61.956 95.532-8.588-16.892-6.804-20.22-6.804-40.372z"
                fill="#FFFFFF" p-id="4800"></path>
            <path
                d="M773.884 1001.684H245.864c-82.196 0-149.068-66.872-149.068-149.068V401.92c0-82.196 66.872-149.068 149.068-149.068h528.02c82.196 0 149.072 66.872 149.072 149.068v450.688c-0.012 82.2-66.876 149.076-149.072 149.076zM245.864 288.856c-62.344 0-113.068 50.724-113.068 113.068v450.692c0 62.344 50.724 113.068 113.068 113.068h528.02c62.344 0 113.072-50.724 113.072-113.068V401.92c0-62.344-50.728-113.068-113.072-113.068l-528.02 0.004z"
                fill="#6E6E96" p-id="4801"></path>
            <path d="M337.612 507.832m-121.704 0a121.704 121.704 0 1 0 243.408 0 121.704 121.704 0 1 0-243.408 0Z"
                fill="#94E5FF" p-id="4802"></path>
            <path
                d="M337.612 647.532c-77.032 0-139.704-62.672-139.704-139.708 0-77.032 62.672-139.704 139.704-139.704 77.036 0 139.708 62.672 139.708 139.704 0 77.036-62.672 139.708-139.708 139.708z m0-243.408c-57.184 0-103.704 46.52-103.704 103.704s46.52 103.708 103.704 103.708c57.184 0 103.708-46.524 103.708-103.708s-46.524-103.704-103.708-103.704z"
                fill="#6E6E96" p-id="4803"></path>
            <path d="M683.548 507.832m-121.704 0a121.704 121.704 0 1 0 243.408 0 121.704 121.704 0 1 0-243.408 0Z"
                fill="#94E5FF" p-id="4804"></path>
            <path
                d="M683.548 647.532c-77.036 0-139.708-62.672-139.708-139.708 0-77.032 62.672-139.704 139.708-139.704 77.032 0 139.704 62.672 139.704 139.704-0.004 77.036-62.672 139.708-139.704 139.708z m0-243.408c-57.188 0-103.708 46.52-103.708 103.704s46.52 103.708 103.708 103.708c57.18 0 103.704-46.524 103.704-103.708s-46.524-103.704-103.704-103.704zM901.204 582.4h86.128v36h-86.128z"
                fill="#6E6E96" p-id="4805"></path>
            <path
                d="M339.208 437.144c51.576 0 94.78 35.736 106.276 83.792a109.44 109.44 0 0 0 3.024-25.512c0-60.364-48.936-109.304-109.3-109.304s-109.304 48.936-109.304 109.304c0 8.788 1.064 17.324 3.024 25.512 11.5-48.056 54.704-83.792 106.28-83.792zM683.548 437.144c51.572 0 94.776 35.736 106.272 83.792a109.44 109.44 0 0 0 3.024-25.512c0-60.364-48.936-109.304-109.296-109.304-60.368 0-109.304 48.936-109.304 109.304 0 8.788 1.064 17.324 3.024 25.512 11.496-48.056 54.7-83.792 106.28-83.792z"
                fill="#6E6E96" opacity=".2" p-id="4806"></path>
            <path
                d="M614 775.264h36v104h-36zM374 775.264h36v104h-36zM497.84 775.264h36v104h-36zM497.84 154h36v115.052h-36z"
                fill="#6E6E96" p-id="4807"></path>
            <path d="M512 104m-78 0a78 78 0 1 0 156 0 78 78 0 1 0-156 0Z" fill="#F0F0FF" p-id="4808"></path>
            <path
                d="M512 200c-52.936 0-96-43.064-96-96s43.064-96 96-96c52.932 0 96 43.064 96 96s-43.068 96-96 96z m0-156c-33.084 0-60 26.916-60 60s26.916 60 60 60 60-26.916 60-60-26.916-60-60-60z"
                fill="#6E6E96" p-id="4809"></path>
            <path d="M285.612 466h54V520h-54z" fill="#FFFFFF" opacity=".6" p-id="4810"></path>
            <path d="M365.612 534h24v24h-24z" fill="#FFFFFF" opacity=".3" p-id="4811"></path>
            <path d="M627 474h54V528h-54z" fill="#FFFFFF" opacity=".6" p-id="4812"></path>
            <path d="M707 542h24v24h-24z" fill="#FFFFFF" opacity=".3" p-id="4813"></path>
        </svg>
        æ™ºèƒ½ä¼šè®®èŠå¤©æœºå™¨äºº
    </h1>
    <button class="back-button" onclick="location.href='/'">è¿”å›ä¸»é¡µ</button>
    <div class="chat-container">
        <div class="chat-box" id="chatBox"></div>
        <div class="input-area">
            <textarea id="userInput" placeholder="ç‚¹å‡»å³ä¾§è¯´å‡ºæ‚¨çš„é—®é¢˜ï¼..." onkeyup="handleKeyUp(event)"></textarea>
            <button id="sendButton" onclick="sendMessage()">ğŸ“¤</button>
            <button id="voiceButton" onclick="toggleVoiceRecognition()">ğŸ¤</button>
        </div>
    </div>

    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script>
        const API_KEY = 'sk-cfe3cb5ab2204ebc852b4c077809937f';
        let isStreaming = false;
        let currentStreamResponse = '';
        let recognition;
        let isRecognizing = false;
        let finalTranscript = ''; // move to global
        let isFirst = false;


        window.onload = async function () {
            const meetingText = localStorage.getItem('meetingText');
            console.log("meetingText", meetingText);
            const title = localStorage.getItem("title");
            console.log("title", title);

            if (meetingText) {
                const chatBox = document.getElementById('userInput');
                chatBox.innerText = meetingText;
                localStorage.removeItem('meetingText');
                isFirst = true;
            }

            // automatically send "please generate meeting summary"
            await sendMessage("è¯·ç”Ÿæˆä¼šè®®çºªè¦");
        };


        async function sendMessage() {
            const userInput = document.getElementById('userInput');
            const sendButton = document.getElementById('sendButton');
            const chatBox = document.getElementById('chatBox');

            if (!userInput.value.trim() || isStreaming) return;

            // add user message
            chatBox.appendChild(createMessageElement(userInput.value.trim(), 'user'));

            const userMessage = userInput.value;
            userInput.value = '';
            isStreaming = true;
            sendButton.disabled = true;
            currentStreamResponse = '';

            // create streaming response display element
            const streamingDiv = createMessageElement('', 'assistant streaming');
            chatBox.appendChild(streamingDiv);

            try {
                const response = await fetch('https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${API_KEY}`,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        model: 'qwen-turbo',
                        messages: [
                            {
                                role: 'system',
                                content: 'You are a helpful assistant.'
                            },
                            {
                                role: 'user',
                                content: userMessage
                            }
                        ],
                        stream: true
                    })
                });

                const reader = response.body.getReader();
                const decoder = new TextDecoder();

                while (true) {
                    const { value, done } = await reader.read();
                    if (done) break;

                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n');

                    // è§£æå“åº”æ•°æ®
                    for (const line of lines) {
                        if (line.startsWith('data:')) {
                            try {
                                const jsonData = JSON.parse(line.slice(5));
                                const content = jsonData.choices?.[0]?.delta?.content;
                                if (content) {
                                    currentStreamResponse += content;
                                    streamingDiv.textContent = currentStreamResponse;
                                    scrollToBottom();
                                }
                            } catch (e) {
                                console.error('è§£æå“åº”æ•°æ®å¤±è´¥:', e);
                            }
                        }
                    }
                }

                // remove streaming response element, add final response
                chatBox.removeChild(streamingDiv);
                if (currentStreamResponse) {
                    const responseElement = createMessageElement(currentStreamResponse, 'assistant');
                    chatBox.appendChild(responseElement);

                    // add save button
                    if (isFirst === true) {
                        const saveButton = document.createElement('button');
                        saveButton.textContent = 'ä¿å­˜çºªè¦';
                        console.log("currentStreamResponse before saveSummary:", currentStreamResponse);
                        // add currentStreamResponse as a custom attribute to the button
                        saveButton.dataset.currentStreamResponse = currentStreamResponse;
                        saveButton.onclick = async () => {
                            try {
                                const title = localStorage.getItem("title");
                                console.log(title);
                                // get currentStreamResponse from button's custom attribute
                                const currentStreamResponse = saveButton.dataset.currentStreamResponse;
                                console.log(currentStreamResponse);

                                if (!title || !currentStreamResponse) {
                                    alert('æ ‡é¢˜æˆ–å†…å®¹ç¼ºå¤±ï¼Œæ— æ³•ä¿å­˜');
                                    return;
                                }

                                // remove title from local storage
                                localStorage.removeItem("title");

                                // send POST request to save meeting summary
                                const response = await axios.post('/meetingInfo/saveMeeting', {
                                    meetingTitle: title, // replace with actual meeting ID
                                    Summary: currentStreamResponse
                                }, {
                                    headers: {
                                        'Content-Type': 'application/json'
                                    }
                                });

                                // handle response
                                if (response.data.error) {
                                    alert('ä¿å­˜å¤±è´¥: ' + response.data.error);
                                } else {
                                    alert('ä¼šè®®çºªè¦å·²ä¿å­˜æˆåŠŸ');
                                }
                            } catch (error) {
                                console.error('ä¿å­˜å¤±è´¥:', error);
                                alert('ä¿å­˜å¤±è´¥ï¼Œç»è¿‡ä¿å­˜çš„ä¼šè®®æ‰å¯ä»¥ç”Ÿæˆä¼šè®®çºªè¦');
                            }
                        };

                        responseElement.appendChild(saveButton);
                        isFirst = false
                    }

                }


            } catch (error) {
                console.error('è¯·æ±‚å¤±è´¥:', error);
                chatBox.appendChild(createMessageElement('æŠ±æ­‰ï¼Œå‘ç”Ÿäº†é”™è¯¯ï¼Œè¯·ç¨åé‡è¯•ã€‚', 'assistant'));
            } finally {
                isStreaming = false;
                sendButton.disabled = false;
                currentStreamResponse = '';
                scrollToBottom();
            }
        }

        async function saveSummary(title, summary) {
            try {
                console.log("summary", summary)
                console.log("title", title)
                localStorage.removeItem("title")
                const response = await axios.post('/meetingInfo/saveMeeting', {
                    meetingTitle: title, // replace with actual meeting ID
                    Summary: summary
                });

                // save summary
                if (response.data.error) {
                    alert('ä¿å­˜å¤±è´¥: ' + response.data.error);
                } else {
                    alert('çºªè¦å·²ä¿å­˜æˆåŠŸ');
                }
            } catch (error) {
                console.error('ä¿å­˜å¤±è´¥:', error);
                alert('ä¿å­˜å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•ã€‚');
            }
        }

        function createMessageElement(content, role) {
            const div = document.createElement('div');
            div.className = `message ${role}`;
            div.textContent = content;


            return div; // remove copy button
        }

        function scrollToBottom() {
            const chatBox = document.getElementById('chatBox');
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        function handleKeyUp(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        function toggleVoiceRecognition() {
            if (!('webkitSpeechRecognition' in window)) {
                alert('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³è¯†åˆ«åŠŸèƒ½ï¼Œè¯·ä½¿ç”¨Chromeæµè§ˆå™¨ã€‚');
                return;
            }

            if (isRecognizing) {
                recognition.stop();
                isRecognizing = false;
                document.getElementById('voiceButton').textContent = 'ğŸ¤';
            } else {
                recognition = new webkitSpeechRecognition();
                recognition.lang = 'zh-CN';
                recognition.continuous = true; // set to true for incremental output
                recognition.interimResults = true; // enable intermediate results

                recognition.onstart = function () {
                    console.log('è¯­éŸ³è¯†åˆ«å¼€å§‹');
                    document.getElementById('voiceButton').textContent = 'â¹';
                    finalTranscript = ''; // clear final result
                };

                recognition.onresult = function (event) {
                    let interimTranscript = '';
                    for (let i = event.resultIndex; i < event.results.length; ++i) {
                        if (event.results[i].isFinal) {
                            finalTranscript += event.results[i][0].transcript;
                        } else {
                            interimTranscript += event.results[i][0].transcript;
                        }
                    }
                    document.getElementById('userInput').value = finalTranscript + interimTranscript;
                };

                recognition.onerror = function (event) {
                    console.error('è¯­éŸ³è¯†åˆ«é”™è¯¯:', event.error);
                };

                recognition.onend = function () {
                    console.log('è¯­éŸ³è¯†åˆ«ç»“æŸ');
                    isRecognizing = false;
                    document.getElementById('voiceButton').textContent = 'ğŸ¤';
                };

                recognition.start();
                isRecognizing = true;
            }
        }
    </script>
</body>

</html>